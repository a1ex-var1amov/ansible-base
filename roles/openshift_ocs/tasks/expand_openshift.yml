- name: Obtain cluster ID
  command: oc get machineset -n openshift-machine-api -o jsonpath='{.items[0].metadata.labels.machine\.openshift\.io/cluster-api-cluster}'
  changed_when: False
  register: cluster_id

- name: Add OCS machine sets to the cluster
  k8s:
    definition: "{{ lookup('template', 'workerocs-machineset.yml') }}"
  with_items: '{{ ocs_availability_zones }}'

- name: Waiting since {{ lookup("pipe", "date +%r") }} for {{ ocs_nodes_total }} OCS worker machines to come up
  k8s_info:
    api_version: machine.openshift.io/v1beta1
    kind: Machine
    namespace: openshift-machine-api
    label_selectors:
      - machine.openshift.io/cluster-api-machine-role=workerocs
  register: ocs_machines
  until: (ocs_machines.resources | length) == (ocs_nodes_total | int)
  retries: 60
  delay: 10

- name: Waiting since {{ lookup("pipe", "date +%r") }} for {{ ocs_nodes_total }} OCS nodes to join the cluster
  k8s_info:
    api_version: v1
    kind: Node
    label_selectors:
      - cluster.ocs.openshift.io/openshift-storage=
  register: ocs_nodes
  until: (ocs_nodes.resources | list | length) == (ocs_nodes_total | int)
  retries: 60
  delay: 10

- name: List of OCS node names
  set_fact:
    ocs_node_names: '{{ ocs_nodes.resources | json_query("[*].metadata.name") }}'

- name: Existing OCS nodes
  debug:
    var: ocs_node_names

- name: Reserve the nodes for OCS pods only
  command: oc adm taint nodes {{ item }} node.ocs.openshift.io/storage=true:NoSchedule
  when: ((ocs_nodes.resources | selectattr('metadata.name', 'equalto', item) | first).spec.taints | default([]) | selectattr('key', 'equalto', 'node.ocs.openshift.io/storage') | first) is not defined
  with_items: '{{ ocs_node_names }}'
